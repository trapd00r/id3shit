#!/usr/bin/perl
use strict;

use MP3::Info;
use MP3::Info qw(:genres);
use Getopt::Long;

our $APP     = 'id3shit';
our $VERSION = 2.1;

my $mp3 = MP3::Info->new;

our ($read_tags,$read_info, $remove, @write, $genres, $rename);

GetOptions('read_tags'  =>  \$read_tags,
           'read_info'  =>  \$read_info,
           'remove'     =>  \$remove,
           'write=s{2}' =>  \@write,
           'genres'     =>  \$genres,
           'name'     =>  \$rename,
           );

my @files = @ARGV;
if(!@ARGV) {
  &help;
}
if($read_tags) {
  &read_tags(@files);
}
if($read_info) {
  &read_info(@files);
}
if($remove) {
  &remove_tags(@files);
}
if(@write) {
  &write_tags(@files);
}
if($genres) {
  &show_genres;
}
if($rename) {
  name(@files);
}

sub show_genres {
  foreach my $genre(sort(keys(%mp3_genres))) {
    printf("% 2s | %0s\n", $mp3_genres{$genre}, $genre);
  }
  printf("----------\n\033[31;1m%0s \033[0m|\033[31;1m %0s\033[0m\n",
        'NO', 'NAME');
  exit 0;
}

sub write_tags {
  my @f_to_write = @_;
  foreach my $file(@files) {
    my $tags = get_mp3tag($file, 1);
    $tags->{uc($write[0])}=ucfirst($write[1]);
    
    set_mp3tag($file, $tags);
    &read_tags($file);
  }
  exit 0;
}


sub remove_tags {
  my @f_to_fuckup = @_;
  foreach my $file(@f_to_fuckup) {
    print 'Removed ', remove_mp3tag($file, 'ALL'), "bytes\n";
  }
  exit 0;
}

sub read_tags {
  my @f_to_read = @_;
  foreach my $file(@f_to_read) {
    my $tags = get_mp3tag($file, 1);

    printf("%11s : %0s\n", 'FILE', "\033[31;1m$file\033[0m");                  
    while(my($key,$value) = each %$tags) {
      printf("%11s : %0s\n", $key, $value);
    }
    print "\n";
  }
  exit 0;
}

sub name {
  my @files = @_;
  return unless(@files);
  print "$_\n" for @files;

  for my $file(@files) {
    my $tags = get_mp3tag($file, 1);
    print Dumper $tags;
    print "OK\n";
  }
  exit(0);
}

sub read_info {
  my @f_to_operate = @_;
  foreach my $file(@f_to_operate) {
    my $info = get_mp3info($file);

    printf("%12s : %0s\n", 'FILE', "\033[31;1m$file\033[0m");
    while(my($key,$value) = each %$info) {
      printf("%12s : %0s\n", $key, $value);
    }
    print "\n";
  }
  exit 0;
}

sub help {
  print << "HLEP";
  $APP $VERSION
  USAGE: id3shit [OPTIONS] <FILES>

  OPTIONS:
    -t  --tags    Show ID3V{1,2} tags
    -i  --info    Show audio information
    -r  --remove  Remove known tags
    -w  --write   Write tags. The syntax is --write FIELD VALUE FILE
                  Legal fields are ARTIST, ALBUM, TITLE, YEAR, COMMENT,
                  TRACKNUM, GENRE.

                  Examples:
                  --write artist laleh *.mp3
                  Will give us something like:
                  >> ARTIST: Laleh
HLEP
}
